/*
* Copyright 2018-2021 Peppy ALSA Plugin peppy.player@gmail.com
* 
* This file is the part of the Peppy ALSA Plugin project.
*
* The changes in the Spectrum Analyzer code.
*   Copyright (c) 2021 by Tobias Dyballa <nixiepeppy@gmail.com>
*
* The Peppy ALSA Plugin project was derived from the project 'pivumeter'
*   pivumeter: level meter ALSA plugin for Raspberry Pi HATs and pHATs
*   Copyright (c) 2017 by Phil Howard <phil@pimoroni.com>
*
* The project 'pivumeter' was in turn derived from the project 'ameter'.
*   ameter :  level meter ALSA plugin with SDL display
*   Copyright (c) 2005 by Laurent Georget <laugeo@free.fr>
*   Copyright (c) 2001 by Abramo Bagnara <abramo@alsa-project.org>
*   Copyright (c) 2002 by Steve Harris <steve@plugin.org.uk>
*
* Peppy ALSA Plugin is free software: you can redistribute it and/or 
* modify it under the terms of the GNU General Public License as 
* published by the Free Software Foundation, either version 3 of the 
* License, or (at your option) any later version.
* 
* Peppy ALSA Plugin is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
* 
* You should have received a copy of the GNU General Public License
* along with Peppy ALSA Plugin. If not, see 
* <http://www.gnu.org/licenses/>.
*/

#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <signal.h>

#define _USE_MATH_DEFINES
#define LINE_LENGTH 76

#include <math.h>
#include <fftw3.h>
#include "peppyalsa.h"

static unsigned int input_size = 512;
static unsigned int output_size;   
static double* input_buffer;
static fftw_complex* output_buffer;
static fftw_plan plan;

static char *mypipesa;
static int fifo_fd_sa = -1;
static int spectrum_max;
static int spectrum_size;
static int log_f;
static int log_y;
static int smooth_f;
static int window_function;

static const double hann[] = {0.00000000e+00, 3.77965773e-05, 1.51180595e-04, 3.40134910e-04, 6.04630957e-04, 9.44628746e-04, 1.36007687e-03, 1.85091253e-03, 2.41706151e-03, 3.05843822e-03, 3.77494569e-03, 4.56647559e-03, 5.43290826e-03, 6.37411270e-03, 7.38994662e-03, 8.48025644e-03, 9.64487731e-03, 1.08836332e-02, 1.21963367e-02, 1.35827895e-02, 1.50427819e-02, 1.65760932e-02, 1.81824916e-02, 1.98617342e-02, 2.16135671e-02, 2.34377255e-02, 2.53339336e-02, 2.73019047e-02, 2.93413412e-02, 3.14519350e-02, 3.36333667e-02, 3.58853068e-02, 3.82074146e-02, 4.05993391e-02, 4.30607187e-02, 4.55911813e-02, 4.81903443e-02, 5.08578147e-02, 5.35931893e-02, 5.63960544e-02, 5.92659864e-02, 6.22025514e-02, 6.52053053e-02, 6.82737943e-02, 7.14075543e-02, 7.46061116e-02, 7.78689827e-02, 8.11956742e-02, 8.45856832e-02, 8.80384971e-02, 9.15535940e-02, 9.51304424e-02, 9.87685015e-02, 1.02467221e-01, 1.06226043e-01, 1.10044397e-01, 1.13921708e-01, 1.17857388e-01, 1.21850843e-01, 1.25901469e-01, 1.30008654e-01, 1.34171776e-01, 1.38390206e-01, 1.42663307e-01, 1.46990432e-01, 1.51370928e-01, 1.55804131e-01, 1.60289372e-01, 1.64825973e-01, 1.69413247e-01, 1.74050502e-01, 1.78737036e-01, 1.83472140e-01, 1.88255099e-01, 1.93085190e-01, 1.97961681e-01, 2.02883837e-01, 2.07850913e-01, 2.12862158e-01, 2.17916814e-01, 2.23014117e-01, 2.28153297e-01, 2.33333576e-01, 2.38554171e-01, 2.43814294e-01, 2.49113148e-01, 2.54449933e-01, 2.59823842e-01, 2.65234062e-01, 2.70679775e-01, 2.76160159e-01, 2.81674384e-01, 2.87221617e-01, 2.92801019e-01, 2.98411747e-01, 3.04052952e-01, 3.09723782e-01, 3.15423378e-01, 3.21150881e-01, 3.26905422e-01, 3.32686134e-01, 3.38492141e-01, 3.44322565e-01, 3.50176526e-01, 3.56053138e-01, 3.61951513e-01, 3.67870760e-01, 3.73809982e-01, 3.79768282e-01, 3.85744760e-01, 3.91738511e-01, 3.97748631e-01, 4.03774209e-01, 4.09814335e-01, 4.15868096e-01, 4.21934577e-01, 4.28012860e-01, 4.34102027e-01, 4.40201156e-01, 4.46309327e-01, 4.52425614e-01, 4.58549094e-01, 4.64678841e-01, 4.70813928e-01, 4.76953428e-01, 4.83096412e-01, 4.89241951e-01, 4.95389117e-01, 5.01536980e-01, 5.07684611e-01, 5.13831080e-01, 5.19975458e-01, 5.26116815e-01, 5.32254225e-01, 5.38386758e-01, 5.44513487e-01, 5.50633486e-01, 5.56745831e-01, 5.62849596e-01, 5.68943859e-01, 5.75027699e-01, 5.81100196e-01, 5.87160431e-01, 5.93207489e-01, 5.99240456e-01, 6.05258418e-01, 6.11260467e-01, 6.17245695e-01, 6.23213197e-01, 6.29162070e-01, 6.35091417e-01, 6.41000339e-01, 6.46887944e-01, 6.52753341e-01, 6.58595644e-01, 6.64413970e-01, 6.70207439e-01, 6.75975174e-01, 6.81716305e-01, 6.87429962e-01, 6.93115283e-01, 6.98771407e-01, 7.04397480e-01, 7.09992651e-01, 7.15556073e-01, 7.21086907e-01, 7.26584315e-01, 7.32047467e-01, 7.37475536e-01, 7.42867702e-01, 7.48223150e-01, 7.53541070e-01, 7.58820659e-01, 7.64061117e-01, 7.69261652e-01, 7.74421479e-01, 7.79539817e-01, 7.84615893e-01, 7.89648938e-01, 7.94638193e-01, 7.99582902e-01, 8.04482319e-01, 8.09335702e-01, 8.14142317e-01, 8.18901439e-01, 8.23612347e-01, 8.28274329e-01, 8.32886681e-01, 8.37448705e-01, 8.41959711e-01, 8.46419017e-01, 8.50825950e-01, 8.55179843e-01, 8.59480037e-01, 8.63725883e-01, 8.67916738e-01, 8.72051970e-01, 8.76130952e-01, 8.80153069e-01, 8.84117711e-01, 8.88024281e-01, 8.91872186e-01, 8.95660845e-01, 8.99389686e-01, 9.03058145e-01, 9.06665667e-01, 9.10211707e-01, 9.13695728e-01, 9.17117204e-01, 9.20475618e-01, 9.23770461e-01, 9.27001237e-01, 9.30167455e-01, 9.33268638e-01, 9.36304317e-01, 9.39274033e-01, 9.42177336e-01, 9.45013788e-01, 9.47782960e-01, 9.50484434e-01, 9.53117800e-01, 9.55682662e-01, 9.58178630e-01, 9.60605328e-01, 9.62962389e-01, 9.65249456e-01, 9.67466184e-01, 9.69612237e-01, 9.71687291e-01, 9.73691033e-01, 9.75623159e-01, 9.77483377e-01, 9.79271407e-01, 9.80986977e-01, 9.82629829e-01, 9.84199713e-01, 9.85696393e-01, 9.87119643e-01, 9.88469246e-01, 9.89745000e-01, 9.90946711e-01, 9.92074198e-01, 9.93127290e-01, 9.94105827e-01, 9.95009663e-01, 9.95838660e-01, 9.96592693e-01, 9.97271648e-01, 9.97875422e-01, 9.98403924e-01, 9.98857075e-01, 9.99234805e-01, 9.99537058e-01, 9.99763787e-01, 9.99914959e-01, 9.99990551e-01, 9.99990551e-01, 9.99914959e-01, 9.99763787e-01, 9.99537058e-01, 9.99234805e-01, 9.98857075e-01, 9.98403924e-01, 9.97875422e-01, 9.97271648e-01, 9.96592693e-01, 9.95838660e-01, 9.95009663e-01, 9.94105827e-01, 9.93127290e-01, 9.92074198e-01, 9.90946711e-01, 9.89745000e-01, 9.88469246e-01, 9.87119643e-01, 9.85696393e-01, 9.84199713e-01, 9.82629829e-01, 9.80986977e-01, 9.79271407e-01, 9.77483377e-01, 9.75623159e-01, 9.73691033e-01, 9.71687291e-01, 9.69612237e-01, 9.67466184e-01, 9.65249456e-01, 9.62962389e-01, 9.60605328e-01, 9.58178630e-01, 9.55682662e-01, 9.53117800e-01, 9.50484434e-01, 9.47782960e-01, 9.45013788e-01, 9.42177336e-01, 9.39274033e-01, 9.36304317e-01, 9.33268638e-01, 9.30167455e-01, 9.27001237e-01, 9.23770461e-01, 9.20475618e-01, 9.17117204e-01, 9.13695728e-01, 9.10211707e-01, 9.06665667e-01, 9.03058145e-01, 8.99389686e-01, 8.95660845e-01, 8.91872186e-01, 8.88024281e-01, 8.84117711e-01, 8.80153069e-01, 8.76130952e-01, 8.72051970e-01, 8.67916738e-01, 8.63725883e-01, 8.59480037e-01, 8.55179843e-01, 8.50825950e-01, 8.46419017e-01, 8.41959711e-01, 8.37448705e-01, 8.32886681e-01, 8.28274329e-01, 8.23612347e-01, 8.18901439e-01, 8.14142317e-01, 8.09335702e-01, 8.04482319e-01, 7.99582902e-01, 7.94638193e-01, 7.89648938e-01, 7.84615893e-01, 7.79539817e-01, 7.74421479e-01, 7.69261652e-01, 7.64061117e-01, 7.58820659e-01, 7.53541070e-01, 7.48223150e-01, 7.42867702e-01, 7.37475536e-01, 7.32047467e-01, 7.26584315e-01, 7.21086907e-01, 7.15556073e-01, 7.09992651e-01, 7.04397480e-01, 6.98771407e-01, 6.93115283e-01, 6.87429962e-01, 6.81716305e-01, 6.75975174e-01, 6.70207439e-01, 6.64413970e-01, 6.58595644e-01, 6.52753341e-01, 6.46887944e-01, 6.41000339e-01, 6.35091417e-01, 6.29162070e-01, 6.23213197e-01, 6.17245695e-01, 6.11260467e-01, 6.05258418e-01, 5.99240456e-01, 5.93207489e-01, 5.87160431e-01, 5.81100196e-01, 5.75027699e-01, 5.68943859e-01, 5.62849596e-01, 5.56745831e-01, 5.50633486e-01, 5.44513487e-01, 5.38386758e-01, 5.32254225e-01, 5.26116815e-01, 5.19975458e-01, 5.13831080e-01, 5.07684611e-01, 5.01536980e-01, 4.95389117e-01, 4.89241951e-01, 4.83096412e-01, 4.76953428e-01, 4.70813928e-01, 4.64678841e-01, 4.58549094e-01, 4.52425614e-01, 4.46309327e-01, 4.40201156e-01, 4.34102027e-01, 4.28012860e-01, 4.21934577e-01, 4.15868096e-01, 4.09814335e-01, 4.03774209e-01, 3.97748631e-01, 3.91738511e-01, 3.85744760e-01, 3.79768282e-01, 3.73809982e-01, 3.67870760e-01, 3.61951513e-01, 3.56053138e-01, 3.50176526e-01, 3.44322565e-01, 3.38492141e-01, 3.32686134e-01, 3.26905422e-01, 3.21150881e-01, 3.15423378e-01, 3.09723782e-01, 3.04052952e-01, 2.98411747e-01, 2.92801019e-01, 2.87221617e-01, 2.81674384e-01, 2.76160159e-01, 2.70679775e-01, 2.65234062e-01, 2.59823842e-01, 2.54449933e-01, 2.49113148e-01, 2.43814294e-01, 2.38554171e-01, 2.33333576e-01, 2.28153297e-01, 2.23014117e-01, 2.17916814e-01, 2.12862158e-01, 2.07850913e-01, 2.02883837e-01, 1.97961681e-01, 1.93085190e-01, 1.88255099e-01, 1.83472140e-01, 1.78737036e-01, 1.74050502e-01, 1.69413247e-01, 1.64825973e-01, 1.60289372e-01, 1.55804131e-01, 1.51370928e-01, 1.46990432e-01, 1.42663307e-01, 1.38390206e-01, 1.34171776e-01, 1.30008654e-01, 1.25901469e-01, 1.21850843e-01, 1.17857388e-01, 1.13921708e-01, 1.10044397e-01, 1.06226043e-01, 1.02467221e-01, 9.87685015e-02, 9.51304424e-02, 9.15535940e-02, 8.80384971e-02, 8.45856832e-02, 8.11956742e-02, 7.78689827e-02, 7.46061116e-02, 7.14075543e-02, 6.82737943e-02, 6.52053053e-02, 6.22025514e-02, 5.92659864e-02, 5.63960544e-02, 5.35931893e-02, 5.08578147e-02, 4.81903443e-02, 4.55911813e-02, 4.30607187e-02, 4.05993391e-02, 3.82074146e-02, 3.58853068e-02, 3.36333667e-02, 3.14519350e-02, 2.93413412e-02, 2.73019047e-02, 2.53339336e-02, 2.34377255e-02, 2.16135671e-02, 1.98617342e-02, 1.81824916e-02, 1.65760932e-02, 1.50427819e-02, 1.35827895e-02, 1.21963367e-02, 1.08836332e-02, 9.64487731e-03, 8.48025644e-03, 7.38994662e-03, 6.37411270e-03, 5.43290826e-03, 4.56647559e-03, 3.77494569e-03, 3.05843822e-03, 2.41706151e-03, 1.85091253e-03, 1.36007687e-03, 9.44628746e-04, 6.04630957e-04, 3.40134910e-04, 1.51180595e-04, 3.77965773e-05, 0.00000000e+00};
static const double hamm[] = {0.08, 0.08003477, 0.08013909, 0.08031292, 0.08055626, 0.08086906, 0.08125127, 0.08170284, 0.0822237, 0.08281376, 0.08347295, 0.08420116, 0.08499828, 0.08586418, 0.08679875, 0.08780184, 0.08887329, 0.09001294, 0.09122063, 0.09249617, 0.09383936, 0.09525001, 0.09672789, 0.0982728, 0.09988448, 0.10156271, 0.10330722, 0.10511775, 0.10699403, 0.10893578, 0.1109427, 0.11301448, 0.11515082, 0.11735139, 0.11961586, 0.12194389, 0.12433512, 0.12678919, 0.12930573, 0.13188437, 0.13452471, 0.13722635, 0.13998888, 0.14281189, 0.14569495, 0.14863762, 0.15163946, 0.15470002, 0.15781883, 0.16099542, 0.16422931, 0.16752001, 0.17086702, 0.17426984, 0.17772796, 0.18124085, 0.18480797, 0.1884288, 0.19210278, 0.19582935, 0.19960796, 0.20343803, 0.20731899, 0.21125024, 0.2152312, 0.21926125, 0.2233398, 0.22746622, 0.2316399, 0.23586019, 0.24012646, 0.24443807, 0.24879437, 0.25319469, 0.25763837, 0.26212475, 0.26665313, 0.27122284, 0.27583319, 0.28048347, 0.28517299, 0.28990103, 0.29466689, 0.29946984, 0.30430915, 0.3091841, 0.31409394, 0.31903793, 0.32401534, 0.32902539, 0.33406735, 0.33914043, 0.34424389, 0.34937694, 0.35453881, 0.35972872, 0.36494588, 0.37018951, 0.37545881, 0.38075299, 0.38607124, 0.39141277, 0.39677676, 0.4021624, 0.40756889, 0.41299539, 0.4184411, 0.42390518, 0.42938682, 0.43488518, 0.44039943, 0.44592874, 0.45147227, 0.45702919, 0.46259865, 0.46817981, 0.47377183, 0.47937386, 0.48498506, 0.49060458, 0.49623157, 0.50186517, 0.50750453, 0.51314881, 0.51879715, 0.5244487, 0.5301026, 0.53575799, 0.54141402, 0.54706984, 0.55272459, 0.55837742, 0.56402747, 0.56967389, 0.57531582, 0.58095241, 0.58658281, 0.59220616, 0.59782163, 0.60342835, 0.60902548, 0.61461218, 0.6201876, 0.62575089, 0.63130122, 0.63683774, 0.64235963, 0.64786604, 0.65335614, 0.6588291, 0.6642841, 0.66972031, 0.67513691, 0.68053307, 0.68590799, 0.69126085, 0.69659084, 0.70189716, 0.707179, 0.71243557, 0.71766606, 0.72286969, 0.72804568, 0.73319324, 0.73831159, 0.74339995, 0.74845757, 0.75348367, 0.75847749, 0.76343829, 0.7683653, 0.77325778, 0.77811501, 0.78293623, 0.78772072, 0.79246776, 0.79717663, 0.80184662, 0.80647702, 0.81106714, 0.81561627, 0.82012373, 0.82458885, 0.82901093, 0.83338932, 0.83772336, 0.84201238, 0.84625575, 0.85045281, 0.85460293, 0.8587055, 0.86275987, 0.86676546, 0.87072163, 0.87462781, 0.8784834, 0.88228781, 0.88604048, 0.88974082, 0.89338829, 0.89698234, 0.90052241, 0.90400798, 0.90743851, 0.91081349, 0.91413241, 0.91739477, 0.92060007, 0.92374783, 0.92683757, 0.92986882, 0.93284114, 0.93575406, 0.93860715, 0.94139997, 0.94413211, 0.94680315, 0.94941269, 0.95196032, 0.95444568, 0.95686838, 0.95922805, 0.96152434, 0.9637569, 0.9659254, 0.9680295, 0.97006889, 0.97204326, 0.97395231, 0.97579575, 0.97757331, 0.97928471, 0.98092969, 0.98250802, 0.98401944, 0.98546374, 0.98684068, 0.98815007, 0.98939171, 0.9905654, 0.99167097, 0.99270826, 0.99367711, 0.99457736, 0.99540889, 0.99617157, 0.99686528, 0.99748992, 0.99804539, 0.99853161, 0.99894851, 0.99929602, 0.99957409, 0.99978268, 0.99992176, 0.99999131, 0.99999131, 0.99992176, 0.99978268, 0.99957409, 0.99929602, 0.99894851, 0.99853161, 0.99804539, 0.99748992, 0.99686528, 0.99617157, 0.99540889, 0.99457736, 0.99367711, 0.99270826, 0.99167097, 0.9905654, 0.98939171, 0.98815007, 0.98684068, 0.98546374, 0.98401944, 0.98250802, 0.98092969, 0.97928471, 0.97757331, 0.97579575, 0.97395231, 0.97204326, 0.97006889, 0.9680295, 0.9659254, 0.9637569, 0.96152434, 0.95922805, 0.95686838, 0.95444568, 0.95196032, 0.94941269, 0.94680315, 0.94413211, 0.94139997, 0.93860715, 0.93575406, 0.93284114, 0.92986882, 0.92683757, 0.92374783, 0.92060007, 0.91739477, 0.91413241, 0.91081349, 0.90743851, 0.90400798, 0.90052241, 0.89698234, 0.89338829, 0.88974082, 0.88604048, 0.88228781, 0.8784834, 0.87462781, 0.87072163, 0.86676546, 0.86275987, 0.8587055, 0.85460293, 0.85045281, 0.84625575, 0.84201238, 0.83772336, 0.83338932, 0.82901093, 0.82458885, 0.82012373, 0.81561627, 0.81106714, 0.80647702, 0.80184662, 0.79717663, 0.79246776, 0.78772072, 0.78293623, 0.77811501, 0.77325778, 0.7683653, 0.76343829, 0.75847749, 0.75348367, 0.74845757, 0.74339995, 0.73831159, 0.73319324, 0.72804568, 0.72286969, 0.71766606, 0.71243557, 0.707179, 0.70189716, 0.69659084, 0.69126085, 0.68590799, 0.68053307, 0.67513691, 0.66972031, 0.6642841, 0.6588291, 0.65335614, 0.64786604, 0.64235963, 0.63683774, 0.63130122, 0.62575089, 0.6201876, 0.61461218, 0.60902548, 0.60342835, 0.59782163, 0.59220616, 0.58658281, 0.58095241, 0.57531582, 0.56967389, 0.56402747, 0.55837742, 0.55272459, 0.54706984, 0.54141402, 0.53575799, 0.5301026, 0.5244487, 0.51879715, 0.51314881, 0.50750453, 0.50186517, 0.49623157, 0.49060458, 0.48498506, 0.47937386, 0.47377183, 0.46817981, 0.46259865, 0.45702919, 0.45147227, 0.44592874, 0.44039943, 0.43488518, 0.42938682, 0.42390518, 0.4184411, 0.41299539, 0.40756889, 0.4021624, 0.39677676, 0.39141277, 0.38607124, 0.38075299, 0.37545881, 0.37018951, 0.36494588, 0.35972872, 0.35453881, 0.34937694, 0.34424389, 0.33914043, 0.33406735, 0.32902539, 0.32401534, 0.31903793, 0.31409394, 0.3091841, 0.30430915, 0.29946984, 0.29466689, 0.28990103, 0.28517299, 0.28048347, 0.27583319, 0.27122284, 0.26665313, 0.26212475, 0.25763837, 0.25319469, 0.24879437, 0.24443807, 0.24012646, 0.23586019, 0.2316399, 0.22746622, 0.2233398, 0.21926125, 0.2152312, 0.21125024, 0.20731899, 0.20343803, 0.19960796, 0.19582935, 0.19210278, 0.1884288, 0.18480797, 0.18124085, 0.17772796, 0.17426984, 0.17086702, 0.16752001, 0.16422931, 0.16099542, 0.15781883, 0.15470002, 0.15163946, 0.14863762, 0.14569495, 0.14281189, 0.13998888, 0.13722635, 0.13452471, 0.13188437, 0.12930573, 0.12678919, 0.12433512, 0.12194389, 0.11961586, 0.11735139, 0.11515082, 0.11301448, 0.1109427, 0.10893578, 0.10699403, 0.10511775, 0.10330722, 0.10156271, 0.09988448, 0.0982728, 0.09672789, 0.09525001, 0.09383936, 0.09249617, 0.09122063, 0.09001294, 0.08887329, 0.08780184, 0.08679875, 0.08586418, 0.08499828, 0.08420116, 0.08347295, 0.08281376, 0.0822237, 0.08170284, 0.08125127, 0.08086906, 0.08055626, 0.08031292, 0.08013909, 0.08003477, 0.08};
static const double black[] = {-1.38777878e-17, 1.36076821e-05, 5.44396417e-05, 1.22522610e-04, 2.17901115e-04, 3.40637436e-04, 4.90811553e-04, 6.68521073e-04, 8.73881144e-04, 1.10702435e-03, 1.36810059e-03, 1.65727694e-03, 1.97473753e-03, 2.32068333e-03, 2.69533202e-03, 3.09891776e-03, 3.53169097e-03, 3.99391816e-03, 4.48588162e-03, 5.00787921e-03, 5.56022407e-03, 6.14324435e-03, 6.75728289e-03, 7.40269693e-03, 8.07985777e-03, 8.78915044e-03, 9.53097332e-03, 1.03057378e-02, 1.11138680e-02, 1.19558001e-02, 1.28319822e-02, 1.37428738e-02, 1.46889454e-02, 1.56706781e-02, 1.66885631e-02, 1.77431010e-02, 1.88348019e-02, 1.99641844e-02, 2.11317753e-02, 2.23381092e-02, 2.35837277e-02, 2.48691792e-02, 2.61950183e-02, 2.75618050e-02, 2.89701044e-02, 3.04204862e-02, 3.19135240e-02, 3.34497947e-02, 3.50298781e-02, 3.66543562e-02, 3.83238126e-02, 4.00388319e-02, 4.17999993e-02, 4.36078998e-02, 4.54631175e-02, 4.73662354e-02, 4.93178343e-02, 5.13184926e-02, 5.33687854e-02, 5.54692840e-02, 5.76205553e-02, 5.98231611e-02, 6.20776577e-02, 6.43845948e-02, 6.67445154e-02, 6.91579549e-02, 7.16254407e-02, 7.41474910e-02, 7.67246152e-02, 7.93573121e-02, 8.20460702e-02, 8.47913668e-02, 8.75936672e-02, 9.04534244e-02, 9.33710781e-02, 9.63470548e-02, 9.93817664e-02, 1.02475610e-01, 1.05628968e-01, 1.08842205e-01, 1.12115672e-01, 1.15449700e-01, 1.18844604e-01, 1.22300681e-01, 1.25818208e-01, 1.29397444e-01, 1.33038628e-01, 1.36741977e-01, 1.40507691e-01, 1.44335945e-01, 1.48226895e-01, 1.52180672e-01, 1.56197387e-01, 1.60277126e-01, 1.64419954e-01, 1.68625909e-01, 1.72895007e-01, 1.77227237e-01, 1.81622565e-01, 1.86080931e-01, 1.90602249e-01, 1.95186405e-01, 1.99833262e-01, 2.04542653e-01, 2.09314386e-01, 2.14148240e-01, 2.19043967e-01, 2.24001291e-01, 2.29019908e-01, 2.34099486e-01, 2.39239663e-01, 2.44440050e-01, 2.49700227e-01, 2.55019746e-01, 2.60398130e-01, 2.65834872e-01, 2.71329435e-01, 2.76881254e-01, 2.82489733e-01, 2.88154247e-01, 2.93874140e-01, 2.99648728e-01, 3.05477295e-01, 3.11359097e-01, 3.17293360e-01, 3.23279280e-01, 3.29316022e-01, 3.35402724e-01, 3.41538492e-01, 3.47722405e-01, 3.53953511e-01, 3.60230830e-01, 3.66553352e-01, 3.72920039e-01, 3.79329825e-01, 3.85781615e-01, 3.92274286e-01, 3.98806688e-01, 4.05377642e-01, 4.11985943e-01, 4.18630359e-01, 4.25309631e-01, 4.32022473e-01, 4.38767576e-01, 4.45543603e-01, 4.52349192e-01, 4.59182958e-01, 4.66043489e-01, 4.72929351e-01, 4.79839088e-01, 4.86771219e-01, 4.93724240e-01, 5.00696627e-01, 5.07686834e-01, 5.14693294e-01, 5.21714420e-01, 5.28748605e-01, 5.35794222e-01, 5.42849627e-01, 5.49913156e-01, 5.56983131e-01, 5.64057853e-01, 5.71135611e-01, 5.78214675e-01, 5.85293302e-01, 5.92369736e-01, 5.99442204e-01, 6.06508924e-01, 6.13568099e-01, 6.20617924e-01, 6.27656579e-01, 6.34682238e-01, 6.41693064e-01, 6.48687212e-01, 6.55662828e-01, 6.62618054e-01, 6.69551023e-01, 6.76459865e-01, 6.83342703e-01, 6.90197658e-01, 6.97022848e-01, 7.03816387e-01, 7.10576390e-01, 7.17300970e-01, 7.23988241e-01, 7.30636316e-01, 7.37243312e-01, 7.43807348e-01, 7.50326547e-01, 7.56799035e-01, 7.63222944e-01, 7.69596412e-01, 7.75917584e-01, 7.82184611e-01, 7.88395654e-01, 7.94548883e-01, 8.00642478e-01, 8.06674628e-01, 8.12643536e-01, 8.18547418e-01, 8.24384500e-01, 8.30153024e-01, 8.35851248e-01, 8.41477444e-01, 8.47029901e-01, 8.52506925e-01, 8.57906839e-01, 8.63227988e-01, 8.68468732e-01, 8.73627455e-01, 8.78702560e-01, 8.83692473e-01, 8.88595641e-01, 8.93410535e-01, 8.98135650e-01, 9.02769505e-01, 9.07310646e-01, 9.11757642e-01, 9.16109091e-01, 9.20363618e-01, 9.24519875e-01, 9.28576542e-01, 9.32532330e-01, 9.36385979e-01, 9.40136259e-01, 9.43781972e-01, 9.47321948e-01, 9.50755055e-01, 9.54080188e-01, 9.57296278e-01, 9.60402288e-01, 9.63397218e-01, 9.66280099e-01, 9.69049999e-01, 9.71706021e-01, 9.74247305e-01, 9.76673025e-01, 9.78982392e-01, 9.81174657e-01, 9.83249106e-01, 9.85205062e-01, 9.87041888e-01, 9.88758985e-01, 9.90355791e-01, 9.91831786e-01, 9.93186485e-01, 9.94419447e-01, 9.95530266e-01, 9.96518581e-01, 9.97384066e-01, 9.98126439e-01, 9.98745455e-01, 9.99240912e-01, 9.99612646e-01, 9.99860537e-01, 9.99984503e-01, 9.99984503e-01, 9.99860537e-01, 9.99612646e-01, 9.99240912e-01, 9.98745455e-01, 9.98126439e-01, 9.97384066e-01, 9.96518581e-01, 9.95530266e-01, 9.94419447e-01, 9.93186485e-01, 9.91831786e-01, 9.90355791e-01, 9.88758985e-01, 9.87041888e-01, 9.85205062e-01, 9.83249106e-01, 9.81174657e-01, 9.78982392e-01, 9.76673025e-01, 9.74247305e-01, 9.71706021e-01, 9.69049999e-01, 9.66280099e-01, 9.63397218e-01, 9.60402288e-01, 9.57296278e-01, 9.54080188e-01, 9.50755055e-01, 9.47321948e-01, 9.43781972e-01, 9.40136259e-01, 9.36385979e-01, 9.32532330e-01, 9.28576542e-01, 9.24519875e-01, 9.20363618e-01, 9.16109091e-01, 9.11757642e-01, 9.07310646e-01, 9.02769505e-01, 8.98135650e-01, 8.93410535e-01, 8.88595641e-01, 8.83692473e-01, 8.78702560e-01, 8.73627455e-01, 8.68468732e-01, 8.63227988e-01, 8.57906839e-01, 8.52506925e-01, 8.47029901e-01, 8.41477444e-01, 8.35851248e-01, 8.30153024e-01, 8.24384500e-01, 8.18547418e-01, 8.12643536e-01, 8.06674628e-01, 8.00642478e-01, 7.94548883e-01, 7.88395654e-01, 7.82184611e-01, 7.75917584e-01, 7.69596412e-01, 7.63222944e-01, 7.56799035e-01, 7.50326547e-01, 7.43807348e-01, 7.37243312e-01, 7.30636316e-01, 7.23988241e-01, 7.17300970e-01, 7.10576390e-01, 7.03816387e-01, 6.97022848e-01, 6.90197658e-01, 6.83342703e-01, 6.76459865e-01, 6.69551023e-01, 6.62618054e-01, 6.55662828e-01, 6.48687212e-01, 6.41693064e-01, 6.34682238e-01, 6.27656579e-01, 6.20617924e-01, 6.13568099e-01, 6.06508924e-01, 5.99442204e-01, 5.92369736e-01, 5.85293302e-01, 5.78214675e-01, 5.71135611e-01, 5.64057853e-01, 5.56983131e-01, 5.49913156e-01, 5.42849627e-01, 5.35794222e-01, 5.28748605e-01, 5.21714420e-01, 5.14693294e-01, 5.07686834e-01, 5.00696627e-01, 4.93724240e-01, 4.86771219e-01, 4.79839088e-01, 4.72929351e-01, 4.66043489e-01, 4.59182958e-01, 4.52349192e-01, 4.45543603e-01, 4.38767576e-01, 4.32022473e-01, 4.25309631e-01, 4.18630359e-01, 4.11985943e-01, 4.05377642e-01, 3.98806688e-01, 3.92274286e-01, 3.85781615e-01, 3.79329825e-01, 3.72920039e-01, 3.66553352e-01, 3.60230830e-01, 3.53953511e-01, 3.47722405e-01, 3.41538492e-01, 3.35402724e-01, 3.29316022e-01, 3.23279280e-01, 3.17293360e-01, 3.11359097e-01, 3.05477295e-01, 2.99648728e-01, 2.93874140e-01, 2.88154247e-01, 2.82489733e-01, 2.76881254e-01, 2.71329435e-01, 2.65834872e-01, 2.60398130e-01, 2.55019746e-01, 2.49700227e-01, 2.44440050e-01, 2.39239663e-01, 2.34099486e-01, 2.29019908e-01, 2.24001291e-01, 2.19043967e-01, 2.14148240e-01, 2.09314386e-01, 2.04542653e-01, 1.99833262e-01, 1.95186405e-01, 1.90602249e-01, 1.86080931e-01, 1.81622565e-01, 1.77227237e-01, 1.72895007e-01, 1.68625909e-01, 1.64419954e-01, 1.60277126e-01, 1.56197387e-01, 1.52180672e-01, 1.48226895e-01, 1.44335945e-01, 1.40507691e-01, 1.36741977e-01, 1.33038628e-01, 1.29397444e-01, 1.25818208e-01, 1.22300681e-01, 1.18844604e-01, 1.15449700e-01, 1.12115672e-01, 1.08842205e-01, 1.05628968e-01, 1.02475610e-01, 9.93817664e-02, 9.63470548e-02, 9.33710781e-02, 9.04534244e-02, 8.75936672e-02, 8.47913668e-02, 8.20460702e-02, 7.93573121e-02, 7.67246152e-02, 7.41474910e-02, 7.16254407e-02, 6.91579549e-02, 6.67445154e-02, 6.43845948e-02, 6.20776577e-02, 5.98231611e-02, 5.76205553e-02, 5.54692840e-02, 5.33687854e-02, 5.13184926e-02, 4.93178343e-02, 4.73662354e-02, 4.54631175e-02, 4.36078998e-02, 4.17999993e-02, 4.00388319e-02, 3.83238126e-02, 3.66543562e-02, 3.50298781e-02, 3.34497947e-02, 3.19135240e-02, 3.04204862e-02, 2.89701044e-02, 2.75618050e-02, 2.61950183e-02, 2.48691792e-02, 2.35837277e-02, 2.23381092e-02, 2.11317753e-02, 1.99641844e-02, 1.88348019e-02, 1.77431010e-02, 1.66885631e-02, 1.56706781e-02, 1.46889454e-02, 1.37428738e-02, 1.28319822e-02, 1.19558001e-02, 1.11138680e-02, 1.03057378e-02, 9.53097332e-03, 8.78915044e-03, 8.07985777e-03, 7.40269693e-03, 6.75728289e-03, 6.14324435e-03, 5.56022407e-03, 5.00787921e-03, 4.48588162e-03, 3.99391816e-03, 3.53169097e-03, 3.09891776e-03, 2.69533202e-03, 2.32068333e-03, 1.97473753e-03, 1.65727694e-03, 1.36810059e-03, 1.10702435e-03, 8.73881144e-04, 6.68521073e-04, 4.90811553e-04, 3.40637436e-04, 2.17901115e-04, 1.22522610e-04, 5.44396417e-05, 1.36076821e-05, -1.38777878e-17};

static void open_pipe() {
	fifo_fd_sa = open(mypipesa, O_WRONLY | O_NONBLOCK);
}

static void send_to_pipe(unsigned int value) {
	if(fifo_fd_sa == -1) {
		return;
	}
	write(fifo_fd_sa, &value, sizeof(value));
}

static void cleanup(void) {
	fftw_destroy_plan(plan);
	free(input_buffer);
	fftw_free(output_buffer);
	send_to_pipe(0);
}

static void reader_disconnect_handler(void) {
	if(fifo_fd_sa != -1) {
		close(fifo_fd_sa);
		fifo_fd_sa = -1;
	}
}

static int init(const char *name, int max, int show, int p, int f_log, int y_log, int f_smooth, int window) {
	struct sigaction disconnect_action;	
	memset(&disconnect_action, 0, sizeof(disconnect_action));
	disconnect_action.sa_handler = &reader_disconnect_handler;
	sigaction(SIGPIPE, &disconnect_action, NULL);
	output_size = input_size/2 + 1;
	int size = strlen(name);
	mypipesa = (char*)malloc(size + 1);
	strcpy(mypipesa, name);	
	spectrum_max = max;
	spectrum_size = p;
	log_f = f_log;
	log_y = y_log;
	smooth_f = f_smooth;
	window_function = window;
	mkfifo(mypipesa, 0666);
	open_pipe();
	atexit(cleanup);
	input_buffer = (double*)(fftw_malloc(input_size * sizeof(double)));
	output_buffer = (fftw_complex*)(fftw_malloc(output_size * sizeof(fftw_complex)));
	plan = fftw_plan_dft_r2c_1d(input_size, input_buffer, output_buffer, FFTW_ESTIMATE);
    
    return 0;
}

static void update(int meter_level_l, int meter_level_r, snd_pcm_scope_peppyalsa_t *level) {
	if(fifo_fd_sa == -1) {
		open_pipe();
		if(fifo_fd_sa == -1) {
			return;
		}			
	}
	
	int16_t *ptr_left, *ptr_right;
	snd_pcm_t *pcm = level->pcm;
	snd_pcm_sframes_t size;
	snd_pcm_uframes_t size1;
	snd_pcm_uframes_t offset, cont;
	unsigned int buffer_index = 0;
	unsigned int n, m;
	unsigned int groupsize;
	unsigned int bins[spectrum_size+1];
	static double y_old[257];
    
    size = snd_pcm_meter_get_now(pcm) - level->old;
    
    if (size < 0){
        size += snd_pcm_meter_get_boundary(pcm);
    }

    offset = level->old % snd_pcm_meter_get_bufsize(pcm);
    cont = snd_pcm_meter_get_bufsize(pcm) - offset;    
    size1 = size;
    
    if (size1 > cont){
        size1 = cont;
    }
    
    ptr_left = snd_pcm_scope_s16_get_channel_buffer(level->s16, 0) + offset;
    ptr_right = snd_pcm_scope_s16_get_channel_buffer(level->s16, 1) + offset;
    
    for (n = size1; n > 0; n--) {
        input_buffer[buffer_index] = (*ptr_left + *ptr_right) / 2;
		if (window_function == 1) {input_buffer[buffer_index] = input_buffer[buffer_index] * hann[buffer_index];}
		if (window_function == 2) {input_buffer[buffer_index] = input_buffer[buffer_index] * hamm[buffer_index];}
		if (window_function == 3) {input_buffer[buffer_index] = input_buffer[buffer_index] * black[buffer_index];}
		ptr_right++;
		ptr_left++;
		buffer_index++;
		if(buffer_index >= input_size) {
			fftw_execute(plan);
			// create linear bins for pipe output
			if (log_f < 1) {
			    groupsize = output_size / spectrum_size;
			    for(int m = 0; m < spectrum_size+1; m++) {
			        if (m == 0) {
                        bins[m] = 1; // discard output[0] (DC level)
                    }
                    else {
						bins[m] = bins[m-1] + groupsize;
	                }
                }
			}
			else { // create log-spaced bins
				double  log_gs = log10(256) / spectrum_size;
				bins[0] = 1;
				for(int m = 1; m < spectrum_size+1; m++) {
					int width = 0;
					width = pow(10, (log_gs * m)) - bins[m-1];
					if (width<1) {width = 1;}
					bins[m] = bins[m-1] + width;
				}
			}
			// Fill Bins and send them to the pipe
			for(m = 0; m < spectrum_size; m++) {
				unsigned int x;
				double y = 0;
				for(x = bins[m]; x < bins[m+1]; x++) {
					y = y + (double)sqrt(pow(output_buffer[m][ 0 ], 2) + pow( output_buffer[m][ 1 ], 2));
				}
				y = y / input_size;
				if (y > 65535) {y = 65535;}
				if (y < 0) {y = 0;}
				y = (smooth_f  * y_old[m] + (100-smooth_f) * y) / 100;
				y_old[m] = y;

				if (log_y < 1) {
					y = y / 65535;
				} else {
					y = log10(y) / 4.82;
				}
				if(y < 0) {y = 0;}
				if(y > 1.0) {y = 1.0;}
				send_to_pipe((unsigned int) (y * spectrum_max));
			}
			break;
		}
    }
    return;
}

device spectrum() {
    struct device _spectrum;
    _spectrum.init = &init;
    _spectrum.update = &update;
    return _spectrum;
};
